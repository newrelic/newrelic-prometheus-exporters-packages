###  On Pr creation against main
###
###        checking_pr                 
###   +-----------------------+          
###   |                       |                                                       
###   | Runs sanity checks    |                                                         
###   |                       |                                                          
###   | Tests Packages linux  |                      
###   | if enabled            |                            
###   |                       | 
###   +-----------------------+      

on: 
  pull_request:
    branches: [ main ]


name: Checking PR
jobs:

  fetch_changed_exporters:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: generate matrix
        id: generate-matrix
        run: |
          git fetch -at origin --unshallow
          old=$(git describe --tags --abbrev=0)
          MATRIX_EXPORTERS_JSON="["
          for exporter_path in exporters/* ; do
            EXPORTER_PATH=$(git diff --name-only $old "${exporter_path}/exporter.yml")
            if [[ "$EXPORTER_PATH" == "${exporter_path}/exporter.yml" ]]; then
                MATRIX_EXPORTERS_JSON+="{\"exporter_path\": \"${exporter_path}/exporter.yml\"}"
            fi
          done
          MATRIX_EXPORTERS_JSON="${MATRIX_EXPORTERS_JSON//\}\{/\}, \{}"
          MATRIX_EXPORTERS_JSON+="]"
          echo "${MATRIX_EXPORTERS_JSON}"
          CONTINUE_DOCKER_JOB="no"
          if [[ "${MATRIX_EXPORTERS_JSON}" != "[]" ]]; then
            CONTINUE_DOCKER_JOB="yes"
          fi
          MATRIX_JSON="{\"exporters\": ${MATRIX_EXPORTERS_JSON}}"
          echo "::set-output name=continue::${CONTINUE_DOCKER_JOB}"
          echo "::set-output name=matrix::${MATRIX_JSON}"
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      continue: ${{ steps.generate-matrix.outputs.continue }}

  check_exporter:
    if: needs.fetch_changed_exporters.outputs.continue == 'yes'
    needs: fetch_changed_exporters
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.fetch_changed_exporters.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          go-version: '^1.16'
      - name: Install dependencies
        run: |
          echo "${{ needs.fetch_changed_exporters }}"
          sudo wget -O /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          sudo apt-get install rpm ruby ruby-dev rubygems build-essential
          sudo gem install --no-document fpm
      - name: Check if exporters have been modified and if so run checks
        id: check
        run : |
          git fetch -at origin --unshallow
          source ./scripts/common_functions.sh
          shouldDoRelease
          old=$(git describe --tags --abbrev=0)
          EXPORTER_PATH=$(git diff --name-only $old "${exporter_path}/exporter.yml")
          if [[ "$EXPORTER_PATH" == "${exporter_path}/exporter.yml" ]]; then
            loadVariables
            checkExporter
            if [ "$ERRORS" != "" ];then
              echo Following errors have been found: $ERRORS
              exit 1
            fi
            if [ "$PACKAGE_LINUX" = "true" ];then
              export GOPATH=$(go env GOPATH)
              packageLinux
            fi
          fi



#  checking_pr:
#    name: Checking PR
#    runs-on: ubuntu-latest
#    strategy:
#      matrix:
#        node: [ 10, 12, 14 ]
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v2
#      - uses: actions/setup-go@v2
#        with:
#          go-version: '^1.16'
#      - name: Install dependencies
#        run: |
#          sudo wget -O /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64
#          sudo chmod +x /usr/local/bin/yq
#          sudo apt-get install rpm ruby ruby-dev rubygems build-essential
#          sudo gem install --no-document fpm
#      - name: Check if exporters have been modified and if so run checks
#        id: check
#        run : |
 #         git fetch -at origin --unshallow
 #         source ./scripts/common_functions.sh
 #         shouldDoRelease
 #         old=$(git describe --tags --abbrev=0)
 #         for exporter_path in exporters/* ; do
 #           EXPORTER_PATH=$(git diff --name-only $old "${exporter_path}/exporter.yml")
 #           if [[ "$EXPORTER_PATH" == "${exporter_path}/exporter.yml" ]]; then
 #             loadVariables
 #             checkExporter
 #             if [ "$ERRORS" != "" ];then
 #               echo Following errors have been found: $ERRORS
 #               exit 1
 #             fi
 #             if [ "$PACKAGE_LINUX" = "true" ];then
 #               export GOPATH=$(go env GOPATH)
 #               packageLinux
 ##             fi
  #          fi
  #        done
